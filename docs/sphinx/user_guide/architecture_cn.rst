架构
====

本文档详细介绍 Nexus 平台架构。

设计原则
--------

Nexus 基于以下设计原则构建：

1. **关注点分离**: 每层有特定的职责
2. **抽象**: 在清晰的接口后隐藏实现细节
3. **可移植性**: 最小化应用中的平台特定代码
4. **可测试性**: 为单元测试和仿真而设计
5. **资源效率**: 为受限的嵌入式系统优化

层级架构
--------

.. code-block:: text

    ┌─────────────────────────────────────────────────────────────┐
    │                        应用层                                │
    ├─────────────────────────────────────────────────────────────┤
    │                       中间件层                               │
    │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
    │  │  Shell  │ │   日志  │ │  配置   │ │  事件   │           │
    │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
    ├─────────────────────────────────────────────────────────────┤
    │                    操作系统抽象层 (OSAL)                      │
    │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
    │  │  任务   │ │  互斥锁 │ │  队列   │ │  定时器 │           │
    │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
    ├─────────────────────────────────────────────────────────────┤
    │                    硬件抽象层 (HAL)                          │
    │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
    │  │  GPIO   │ │  UART   │ │   SPI   │ │   I2C   │           │
    │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
    ├─────────────────────────────────────────────────────────────┤
    │                      平台 / 硬件层                           │
    │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
    │  │ STM32F4 │ │ STM32H7 │ │  ESP32  │ │  nRF52  │           │
    │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
    └─────────────────────────────────────────────────────────────┘

应用层
~~~~~~

基于 Nexus 平台构建的用户应用程序。应用应该：

- 只使用下层的公共 API
- 避免直接硬件访问
- 在支持的平台间可移植

中间件层
~~~~~~~~

提供更高级功能的通用服务：

- **日志框架**: 支持多后端的灵活日志
- **Shell**: 用于调试的命令行接口
- **配置**: 配置管理和持久化
- **事件**: 事件驱动编程支持

详见 :doc:`log_cn` 了解日志框架文档。

OSAL 层
~~~~~~~

操作系统抽象层提供可移植的 RTOS 原语：

- **任务**: 线程/任务管理
- **互斥锁**: 互斥锁
- **信号量**: 二值和计数信号量
- **队列**: 任务间通信的消息队列
- **定时器**: 软件定时器

支持的后端：

- FreeRTOS
- Native（用于 PC 仿真的 pthreads）
- 裸机（协作式调度）

详见 :doc:`osal_cn` 了解 OSAL 文档。

HAL 层
~~~~~~

硬件抽象层提供统一的外设 API：

- **GPIO**: 通用输入输出
- **UART**: 串口通信
- **SPI**: SPI 总线主/从
- **I2C**: I2C 总线主/从
- **Timer**: 硬件定时器和 PWM
- **ADC**: 模数转换

详见 :doc:`hal_cn` 了解 HAL 文档。

平台层
~~~~~~

MCU 特定实现，包括：

- 启动代码和系统初始化
- 链接脚本
- 厂商 SDK 集成
- 时钟和电源管理

数据流
------

.. code-block:: text

    应用程序
        │
        ▼
    ┌─────────────────┐
    │    中间件       │  ← 使用 OSAL 进行线程管理，HAL 进行 I/O
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │      OSAL       │  ← 使用 HAL 进行计时
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │       HAL       │  ← 使用平台层进行硬件访问
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │     平台层      │  ← 直接硬件访问
    └─────────────────┘

依赖规则
--------

严格的依赖规则确保清晰的架构：

1. **上层依赖下层**（永不反向）
2. **同层组件相互独立**（无水平依赖）
3. **平台层是唯一可以直接访问硬件的层**

.. code-block:: text

    ✅ 应用 → 中间件 → OSAL → HAL → 平台
    ❌ HAL → 中间件（反向依赖）
    ❌ GPIO → UART（HAL 内的水平依赖）

内存管理
--------

Nexus 支持多种内存管理策略：

**静态分配**
    所有内存在编译时分配。适用于安全关键系统。

**动态分配**
    使用 malloc/free 进行运行时内存分配。更灵活但需要谨慎管理。

**池分配**
    固定大小的内存池，用于可预测的分配模式。

配置示例：

.. code-block:: c

    /* 静态分配模式 */
    #define NEXUS_USE_STATIC_ALLOC  1
    #define NEXUS_MAX_TASKS         8
    #define NEXUS_MAX_MUTEXES       16

错误处理
--------

所有 Nexus API 遵循一致的错误处理：

.. code-block:: c

    /* 所有函数返回状态码 */
    hal_status_t status = hal_gpio_init(port, pin, &config);
    if (status != HAL_OK) {
        /* 处理错误 */
        LOG_ERROR("GPIO 初始化失败: %d", status);
    }

常见状态码：

+------------------------+----------------------------------+
| 状态                   | 描述                             |
+========================+==================================+
| ``XXX_OK``             | 操作成功                         |
+------------------------+----------------------------------+
| ``XXX_ERROR``          | 一般错误                         |
+------------------------+----------------------------------+
| ``XXX_ERROR_PARAM``    | 无效参数                         |
+------------------------+----------------------------------+
| ``XXX_ERROR_STATE``    | 无效状态                         |
+------------------------+----------------------------------+
| ``XXX_ERROR_TIMEOUT``  | 操作超时                         |
+------------------------+----------------------------------+
| ``XXX_ERROR_NO_MEMORY``| 内存分配失败                     |
+------------------------+----------------------------------+

构建系统
--------

Nexus 使用 CMake 进行跨平台构建配置：

.. code-block:: bash

    # 选择平台
    cmake -B build -DNEXUS_PLATFORM=stm32f4

    # 启用功能
    cmake -B build \
        -DNEXUS_PLATFORM=stm32f4 \
        -DNEXUS_BUILD_TESTS=ON \
        -DNEXUS_ENABLE_LOG=ON

主要 CMake 选项：

+---------------------------+----------------------------------+
| 选项                      | 描述                             |
+===========================+==================================+
| ``NEXUS_PLATFORM``        | 目标平台 (stm32f4, native)       |
+---------------------------+----------------------------------+
| ``NEXUS_BUILD_TESTS``     | 构建单元测试                     |
+---------------------------+----------------------------------+
| ``NEXUS_ENABLE_LOG``      | 启用日志框架                     |
+---------------------------+----------------------------------+
| ``NEXUS_ENABLE_COVERAGE`` | 启用代码覆盖率                   |
+---------------------------+----------------------------------+

下一步
------

- :doc:`hal_cn` - 了解硬件抽象层
- :doc:`osal_cn` - 了解操作系统抽象层
- :doc:`log_cn` - 了解日志框架
- :doc:`porting_cn` - 将 Nexus 移植到新平台
