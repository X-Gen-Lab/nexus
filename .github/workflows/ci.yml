name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'hal/**'
              - 'osal/**'
              - 'framework/**'
              - 'platforms/**'
              - 'applications/**'
              - 'tests/**'
              - '**/CMakeLists.txt'
              - 'cmake/**'
              - 'CMakePresets.json'
            docs:
              - 'docs/**'
              - '**.md'
              - 'Doxyfile'
            workflows:
              - '.github/workflows/**'

  build-test:
    name: Build & Test
    needs: changes
    if: needs.changes.outputs.code == 'true' || needs.changes.outputs.workflows == 'true' || github.event_name == 'schedule'
    uses: ./.github/workflows/build-matrix.yml
    secrets: inherit

  code-quality:
    name: Code Quality
    needs: changes
    if: needs.changes.outputs.code == 'true' || needs.changes.outputs.workflows == 'true'
    uses: ./.github/workflows/quality-checks.yml

  docs:
    name: Documentation
    needs: changes
    if: needs.changes.outputs.docs == 'true' || needs.changes.outputs.code == 'true' || github.event_name == 'schedule'
    uses: ./.github/workflows/docs-build.yml
    secrets: inherit
    permissions:
      contents: read
      pages: write
      id-token: write

  status-check:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [build-test, code-quality, docs]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.docs.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-test.result }}" == "failure" ]] || \
             [[ "${{ needs.code-quality.result }}" == "failure" ]]; then
            echo "::error::CI checks failed"
            exit 1
          fi
