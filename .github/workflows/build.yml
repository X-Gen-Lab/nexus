# Nexus Build Workflow
# Builds the project for multiple platforms

name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  CMAKE_VERSION: '3.16'
  PYTHON_VERSION: '3.11'

jobs:
  # Native build (for testing)
  build-native:
    name: Build Native (${{ matrix.os }}, ${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        compiler: [default]
        include:
          - os: ubuntu-latest
            compiler: gcc-11
          - os: ubuntu-latest
            compiler: clang-15

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Setup Compiler (Ubuntu)
      if: matrix.os == 'ubuntu-latest' && matrix.compiler != 'default'
      run: |
        if [ "${{ matrix.compiler }}" = "gcc-11" ]; then
          sudo apt-get update
          sudo apt-get install -y gcc-11 g++-11
          echo "CC=gcc-11" >> $GITHUB_ENV
          echo "CXX=g++-11" >> $GITHUB_ENV
        elif [ "${{ matrix.compiler }}" = "clang-15" ]; then
          sudo apt-get update
          sudo apt-get install -y clang-15
          echo "CC=clang-15" >> $GITHUB_ENV
          echo "CXX=clang++-15" >> $GITHUB_ENV
        fi

    - name: Cache CMake Build
      uses: actions/cache@v4
      with:
        path: |
          build
          ~/.cache/ccache
        key: ${{ runner.os }}-${{ matrix.compiler }}-cmake-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.compiler }}-cmake-

    - name: Configure CMake (Native)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DNEXUS_PLATFORM=native \
          -DNEXUS_BUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

    - name: Run Tests
      working-directory: build
      run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure --parallel

  # ARM cross-compilation
  build-arm:
    name: Build ARM (${{ matrix.platform }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [stm32f4, stm32h7]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Cache ARM Toolchain
      id: cache-arm-toolchain
      uses: actions/cache@v4
      with:
        path: ~/arm-toolchain
        key: arm-none-eabi-gcc-10.3

    - name: Install ARM Toolchain
      if: steps.cache-arm-toolchain.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi

    - name: Cache CMake Build
      uses: actions/cache@v4
      with:
        path: build-${{ matrix.platform }}
        key: ${{ runner.os }}-arm-${{ matrix.platform }}-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-arm-${{ matrix.platform }}-

    - name: Configure CMake (${{ matrix.platform }})
      run: |
        cmake -B build-${{ matrix.platform }} \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/arm-none-eabi.cmake \
          -DNEXUS_PLATFORM=${{ matrix.platform }}

    - name: Build ${{ matrix.platform }}
      run: cmake --build build-${{ matrix.platform }} --config ${{ env.BUILD_TYPE }} --parallel

    - name: Generate Build Report
      run: |
        echo "### Build Summary for ${{ matrix.platform }}" > build-report.md
        echo "" >> build-report.md
        find build-${{ matrix.platform }} -name "*.elf" -exec arm-none-eabi-size {} \; >> build-report.md || true

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-binaries
        path: |
          build-${{ matrix.platform }}/**/*.bin
          build-${{ matrix.platform }}/**/*.hex
          build-${{ matrix.platform }}/**/*.elf
          build-${{ matrix.platform }}/**/*.map
          build-report.md
        retention-days: 30

  # Static analysis
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Analysis Tools
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/cppcheck
          ~/.cache/clang-tools
        key: ${{ runner.os }}-analysis-tools-v1

    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-format clang-tidy

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=missingInclude \
          --suppress=unusedFunction \
          --suppress=unmatchedSuppression \
          --suppress=comparePointers \
          --suppress=constVariablePointer \
          --suppress=duplicateExpression \
          -I hal/include -I osal/include -I framework/include \
          -I platforms/native/include \
          -I platforms/stm32/include \
          --xml --xml-version=2 \
          hal/ osal/ framework/ platforms/ applications/ 2> cppcheck-report.xml || true

    - name: Check Code Format
      run: |
        find hal osal framework platforms applications \
          \( -name "*.c" -o -name "*.h" \) \
          -not -path "*/ext/*" \
          -not -path "*/vendors/*" \
          -not -path "*/build/*" | \
          xargs clang-format --dry-run --Werror

    - name: Run clang-tidy
      run: |
        find hal osal framework \
          -name "*.c" \
          -not -path "*/ext/*" \
          -not -path "*/vendors/*" | \
          head -20 | \
          xargs clang-tidy -p build || true

    - name: Upload Analysis Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: static-analysis-reports
        path: |
          cppcheck-report.xml
        retention-days: 30

  # Documentation build check
  docs-check:
    name: Documentation Build Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Cache Documentation Tools
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          /usr/share/doc/doxygen
        key: ${{ runner.os }}-docs-tools-v1

    - name: Install Doxygen
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz

    - name: Install Sphinx
      run: |
        pip install -r docs/sphinx/requirements.txt

    - name: Build Doxygen
      run: doxygen Doxyfile

    - name: Build Sphinx (English)
      working-directory: docs/sphinx
      run: sphinx-build -W -b html . _build/html/en

    - name: Build Sphinx (Chinese)
      working-directory: docs/sphinx
      run: sphinx-build -W -b html -D language=zh_CN . _build/html/zh_CN

    - name: Check Documentation Links
      working-directory: docs/sphinx
      run: sphinx-build -b linkcheck . _build/linkcheck || true

    - name: Upload Documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation-preview
        path: |
          docs/api/html/
          docs/sphinx/_build/html/
        retention-days: 7

  # Build summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-native, build-arm, static-analysis, docs-check]
    if: always()

    steps:
    - name: Check Build Results
      run: |
        echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Native Build | ${{ needs.build-native.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ARM Build | ${{ needs.build-arm.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Static Analysis | ${{ needs.static-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Documentation | ${{ needs.docs-check.result }} |" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.build-native.result }}" != "success" ] || \
           [ "${{ needs.build-arm.result }}" != "success" ] || \
           [ "${{ needs.static-analysis.result }}" != "success" ] || \
           [ "${{ needs.docs-check.result }}" != "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "❌ Some builds failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All builds passed" >> $GITHUB_STEP_SUMMARY
        fi
