# Nexus Test Workflow
# Runs unit tests and generates coverage reports with threshold checking

name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  MIN_COVERAGE: 95.0
  TARGET_COVERAGE: 100.0

jobs:
  test:
    name: Unit Tests with Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Cache Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          build
        key: ${{ runner.os }}-test-${{ hashFiles('**/CMakeLists.txt', 'requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-test-

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov python3-pip
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Configure CMake with Coverage
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DNEXUS_PLATFORM=native \
          -DNEXUS_BUILD_TESTS=ON \
          -DNEXUS_ENABLE_COVERAGE=ON \
          -DCMAKE_C_FLAGS="--coverage -O0 -g" \
          -DCMAKE_CXX_FLAGS="--coverage -O0 -g"

    - name: Build
      run: cmake --build build --parallel

    - name: Run Tests
      working-directory: build
      run: ctest --output-on-failure --verbose

    - name: Generate Coverage Report
      id: coverage
      run: |
        # Capture coverage data
        lcov --capture --directory build --output-file coverage.info \
          --ignore-errors mismatch,inconsistent,gcov,source

        # Remove external libraries and test code
        lcov --remove coverage.info '/usr/*' '*/ext/*' '*/tests/*' '*/googletest/*' '*/build/*' \
          --output-file coverage.info --ignore-errors unused,source

        # Generate detailed coverage report
        lcov --list coverage.info > coverage_summary.txt

        # Extract overall coverage percentage
        COVERAGE=$(lcov --summary coverage.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Coverage: $COVERAGE%"

        # Generate HTML report
        genhtml coverage.info --output-directory coverage_html \
          --title "Nexus Native HAL Coverage" \
          --legend --show-details

        # Display summary
        echo "=== Coverage Summary ===" | tee -a $GITHUB_STEP_SUMMARY
        cat coverage_summary.txt | tee -a $GITHUB_STEP_SUMMARY

    - name: Get Base Branch Coverage
      id: base_coverage
      if: github.event_name == 'pull_request'
      continue-on-error: true
      run: |
        # Try to get base branch coverage from Codecov API
        BASE_BRANCH="${{ github.base_ref }}"
        REPO="${{ github.repository }}"

        # Fetch coverage from Codecov (if available)
        BASE_COVERAGE=$(curl -s "https://codecov.io/api/gh/${REPO}/branch/${BASE_BRANCH}" | \
          jq -r '.commit.totals.coverage // 0' 2>/dev/null || echo "0")

        # If Codecov API fails, try to get from previous artifact
        if [ "$BASE_COVERAGE" = "0" ] || [ -z "$BASE_COVERAGE" ]; then
          echo "Could not fetch base coverage from Codecov, using default"
          BASE_COVERAGE="0"
        fi

        echo "base_coverage=$BASE_COVERAGE" >> $GITHUB_OUTPUT
        echo "Base branch ($BASE_BRANCH) coverage: $BASE_COVERAGE%"

    - name: Compare Coverage with Base
      if: github.event_name == 'pull_request' && steps.base_coverage.outputs.base_coverage != '0'
      run: |
        chmod +x .github/scripts/compare_coverage.sh
        .github/scripts/compare_coverage.sh \
          "${{ steps.coverage.outputs.coverage }}" \
          "${{ steps.base_coverage.outputs.base_coverage }}" \
          "coverage_comparison.txt"

        # Add comparison to step summary
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Coverage Comparison" >> $GITHUB_STEP_SUMMARY
        cat coverage_comparison.txt >> $GITHUB_STEP_SUMMARY


    - name: Check Coverage Threshold
      run: |
        COVERAGE=${{ steps.coverage.outputs.coverage }}
        MIN_COVERAGE=${{ env.MIN_COVERAGE }}
        TARGET_COVERAGE=${{ env.TARGET_COVERAGE }}

        echo "Current Coverage: $COVERAGE%"
        echo "Minimum Required: $MIN_COVERAGE%"
        echo "Target: $TARGET_COVERAGE%"

        # Add to step summary
        echo "### Coverage Threshold Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Current Coverage | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
        echo "| Minimum Required | ${MIN_COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
        echo "| Target | ${TARGET_COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Compare coverage (using bc for floating point comparison)
        if (( $(echo "$COVERAGE < $MIN_COVERAGE" | bc -l) )); then
          echo "âŒ Coverage $COVERAGE% is below minimum threshold $MIN_COVERAGE%"
          echo "::error::Coverage threshold not met: $COVERAGE% < $MIN_COVERAGE%"
          echo "**Status:** âŒ Below minimum threshold" >> $GITHUB_STEP_SUMMARY
          exit 1
        elif (( $(echo "$COVERAGE < $TARGET_COVERAGE" | bc -l) )); then
          echo "âš ï¸  Coverage $COVERAGE% meets minimum but below target $TARGET_COVERAGE%"
          echo "::warning::Coverage below target: $COVERAGE% < $TARGET_COVERAGE%"
          echo "**Status:** âš ï¸ Meets minimum, below target" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… Coverage $COVERAGE% meets target $TARGET_COVERAGE%"
          echo "**Status:** âœ… Target achieved" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Coverage Report Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: |
          coverage.info
          coverage_summary.txt
          coverage_html/
        retention-days: 30

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: coverage.info
        fail_ci_if_error: false
        verbose: true
        flags: native-hal

    - name: Comment Coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const coverage = '${{ steps.coverage.outputs.coverage }}';
          const baseCoverage = '${{ steps.base_coverage.outputs.base_coverage }}';
          const summary = fs.readFileSync('coverage_summary.txt', 'utf8');

          // Calculate coverage change
          let changeText = '';
          let changeEmoji = '';
          if (baseCoverage && baseCoverage !== '0') {
            const diff = (parseFloat(coverage) - parseFloat(baseCoverage)).toFixed(2);
            if (diff > 0) {
              changeEmoji = 'ðŸ“ˆ';
              changeText = `\n**Coverage Change:** +${diff}% (${baseCoverage}% â†’ ${coverage}%)`;
            } else if (diff < 0) {
              changeEmoji = 'ðŸ“‰';
              changeText = `\n**Coverage Change:** ${diff}% (${baseCoverage}% â†’ ${coverage}%)`;
            } else {
              changeEmoji = 'âž¡ï¸';
              changeText = `\n**Coverage Change:** No change (${coverage}%)`;
            }
          }

          const comment = `## ðŸ“Š Coverage Report ${changeEmoji}

          **Overall Coverage:** ${coverage}%${changeText}

          <details>
          <summary>Detailed Coverage Summary</summary>

          \`\`\`
          ${summary}
          \`\`\`

          </details>

          **Thresholds:**
          - âœ… Minimum: 95%
          - ðŸŽ¯ Target: 100%

          ${parseFloat(coverage) >= 100 ? 'âœ… Target coverage achieved!' :
            parseFloat(coverage) >= 95 ? 'âš ï¸ Meets minimum, below target' :
            'âŒ Below minimum threshold'}

          ---
          ðŸ“¥ [Download Coverage Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # Memory sanitizer tests
  sanitizer:
    name: Sanitizer Tests (${{ matrix.sanitizer }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        sanitizer: [address, undefined, thread]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Configure with ${{ matrix.sanitizer }} Sanitizer
      run: |
        SANITIZER_FLAG=""
        case "${{ matrix.sanitizer }}" in
          address)
            SANITIZER_FLAG="-fsanitize=address -fno-omit-frame-pointer"
            ;;
          undefined)
            SANITIZER_FLAG="-fsanitize=undefined -fno-omit-frame-pointer"
            ;;
          thread)
            SANITIZER_FLAG="-fsanitize=thread"
            ;;
        esac

        cmake -B build-${{ matrix.sanitizer }} \
          -DCMAKE_BUILD_TYPE=Debug \
          -DNEXUS_PLATFORM=native \
          -DNEXUS_BUILD_TESTS=ON \
          -DCMAKE_C_FLAGS="$SANITIZER_FLAG" \
          -DCMAKE_CXX_FLAGS="$SANITIZER_FLAG"

    - name: Build
      run: cmake --build build-${{ matrix.sanitizer }} --parallel

    - name: Run Tests with ${{ matrix.sanitizer }} Sanitizer
      working-directory: build-${{ matrix.sanitizer }}
      run: ctest --output-on-failure --parallel
      env:
        ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1
        UBSAN_OPTIONS: print_stacktrace=1
        TSAN_OPTIONS: second_deadlock_stack=1

  # MISRA compliance check
  misra:
    name: MISRA Compliance Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Create MISRA Configuration
      run: |
        cat > misra.json << 'EOF'
        {
          "script": "misra",
          "args": ["--rule-texts=misra-rules.txt"]
        }
        EOF

    - name: Run MISRA Check
      run: |
        cppcheck --addon=misra.json \
          --suppress=missingIncludeSystem \
          --suppress=missingInclude \
          -I hal/include -I osal/include -I framework/include \
          --xml --xml-version=2 \
          hal/ osal/ framework/ 2> misra-report.xml || true

        # Also generate text report
        cppcheck --addon=misra.json \
          --suppress=missingIncludeSystem \
          --suppress=missingInclude \
          -I hal/include -I osal/include -I framework/include \
          hal/ osal/ framework/ 2>&1 | tee misra-report.txt || true

    - name: Upload MISRA Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: misra-report
        path: |
          misra-report.txt
          misra-report.xml
        retention-days: 30

  # Test summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, sanitizer, misra]
    if: always()

    steps:
    - name: Check Test Results
      run: |
        echo "### Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Sanitizers | ${{ needs.sanitizer.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| MISRA Check | ${{ needs.misra.result }} |" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.test.result }}" != "success" ] || \
           [ "${{ needs.sanitizer.result }}" != "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
        fi
