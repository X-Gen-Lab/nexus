# Nexus Performance Workflow
# Performance benchmarking and regression testing

name: Performance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  PYTHON_VERSION: '3.11'

jobs:
  # Performance benchmarks
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-benchmark matplotlib

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DNEXUS_PLATFORM=native \
          -DNEXUS_BUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

    - name: Run Benchmarks
      working-directory: build
      run: |
        # Run performance tests
        ctest -C ${{ env.BUILD_TYPE }} -L performance --output-on-failure || true

    - name: Generate Performance Report
      run: |
        echo "### Performance Benchmark Results" > performance-report.md
        echo "" >> performance-report.md
        echo "Build Type: ${{ env.BUILD_TYPE }}" >> performance-report.md
        echo "Platform: Native (Ubuntu)" >> performance-report.md
        echo "" >> performance-report.md

    - name: Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: performance-report
        path: performance-report.md

  # Memory profiling
  memory-profile:
    name: Memory Profiling
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        sudo apt-get update
        sudo apt-get install -y valgrind

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DNEXUS_PLATFORM=native \
          -DNEXUS_BUILD_TESTS=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run Valgrind
      working-directory: build
      run: |
        # Run tests under valgrind
        ctest -C Debug -L unit --output-on-failure \
          --overwrite MemoryCheckCommandOptions="--leak-check=full --show-leak-kinds=all" \
          -T memcheck || true

    - name: Generate Memory Report
      run: |
        echo "### Memory Profiling Results" > memory-report.md
        find build/Testing/Temporary -name "MemoryChecker.*.log" -exec cat {} \; >> memory-report.md || true

    - name: Upload Memory Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: memory-report
        path: |
          memory-report.md
          build/Testing/Temporary/MemoryChecker.*.log

  # Code size analysis
  size-analysis:
    name: Code Size Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi

    - name: Build STM32F4
      run: |
        cmake -B build-stm32f4 \
          -DCMAKE_BUILD_TYPE=MinSizeRel \
          -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/arm-none-eabi.cmake \
          -DNEXUS_PLATFORM=stm32f4 \
          -DNEXUS_BUILD_EXAMPLES=ON
        cmake --build build-stm32f4 --parallel

    - name: Analyze Code Size
      run: |
        echo "### Code Size Analysis (STM32F4)" > size-report.md
        echo "" >> size-report.md
        echo "Build Type: MinSizeRel" >> size-report.md
        echo "" >> size-report.md
        echo "#### Application Sizes" >> size-report.md
        echo "" >> size-report.md
        echo '```' >> size-report.md
        find build-stm32f4 -name "*.elf" -exec arm-none-eabi-size -A {} \; >> size-report.md
        echo '```' >> size-report.md

    - name: Upload Size Report
      uses: actions/upload-artifact@v4
      with:
        name: size-report
        path: size-report.md

    - name: Comment Size on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('size-report.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
