# Nexus Performance Workflow
# Performance benchmarking and regression testing

name: Performance

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  workflow_dispatch:

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
          preset: linux-gcc-release

      - name: Configure
        run: cmake --preset linux-gcc-release

      - name: Build
        run: cmake --build --preset linux-gcc-release --parallel

      - name: Run Benchmarks
        run: ctest --preset linux-gcc-release -L performance --output-on-failure || true

      - name: Generate Performance Report
        run: |
          echo "## Performance Benchmark Results" > performance-report.md
          echo "" >> performance-report.md
          echo "**Build Type:** Release" >> performance-report.md
          echo "**Platform:** Native (Ubuntu)" >> performance-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> performance-report.md
          echo "" >> performance-report.md

          if [ -f build/linux-gcc-release/performance-*.txt ]; then
            echo "### Results" >> performance-report.md
            echo "\`\`\`" >> performance-report.md
            cat build/linux-gcc-release/performance-*.txt >> performance-report.md || true
            echo "\`\`\`" >> performance-report.md
          fi

      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md
          retention-days: 90

  memory-profile:
    name: Memory Profiling
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
          preset: linux-gcc-debug

      - name: Install Valgrind
        run: sudo apt-get update && sudo apt-get install -y valgrind

      - name: Configure
        run: cmake --preset linux-gcc-debug

      - name: Build
        run: cmake --build --preset linux-gcc-debug --parallel

      - name: Run Valgrind
        run: |
          ctest --preset linux-gcc-debug -L unit \
            --overwrite MemoryCheckCommandOptions="--leak-check=full --show-leak-kinds=all" \
            -T memcheck || true

      - name: Generate Memory Report
        run: |
          echo "## Memory Profiling Results" > memory-report.md
          echo "" >> memory-report.md
          find build/linux-gcc-debug/Testing/Temporary -name "MemoryChecker.*.log" \
            -exec cat {} \; >> memory-report.md || true

      - name: Upload Memory Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: memory-report
          path: |
            memory-report.md
            build/linux-gcc-debug/Testing/Temporary/MemoryChecker.*.log
          retention-days: 90

  size-analysis:
    name: Code Size Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
          preset: cross-arm-release

      - name: Configure
        run: cmake --preset cross-arm-release

      - name: Build
        run: cmake --build --preset cross-arm-release --parallel

      - name: Analyze Code Size
        run: |
          echo "## Code Size Analysis (ARM Cortex-M4)" > size-report.md
          echo "" >> size-report.md
          echo "**Build Type:** MinSizeRel" >> size-report.md
          echo "**Platform:** STM32F4" >> size-report.md
          echo "" >> size-report.md
          echo "### Application Sizes" >> size-report.md
          echo "" >> size-report.md
          echo "\`\`\`" >> size-report.md
          find build/cross-arm-release -name "*.elf" -exec arm-none-eabi-size -A {} \; >> size-report.md || true
          echo "\`\`\`" >> size-report.md

      - name: Upload Size Report
        uses: actions/upload-artifact@v4
        with:
          name: size-report
          path: size-report.md
          retention-days: 90
